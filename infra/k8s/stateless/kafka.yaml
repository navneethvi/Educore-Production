# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   namespace: kafka
#   labels:
#     app: zookeeper
#   name: zookeeper
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: zookeeper
#   template:
#     metadata:
#       labels:
#         app: zookeeper
#     spec:
#       containers:
#         - image: wurstmeister/zookeeper
#           imagePullPolicy: IfNotPresent
#           name: zookeeper
#           ports:
#             - containerPort: 2181
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   namespace: kafka
#   labels:
#     app: zookeeper-service
#   name: zookeeper-service
# spec:
#   type: ClusterIP
#   selector:
#     app: zookeeper
#   ports:
#     - name: zookeeper-port
#       port: 2181
#       targetPort: 2181
# ---
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   namespace: kafka
#   labels:
#     app: kafka-broker
#   name: kafka-broker
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: kafka-broker
#   template:
#     metadata:
#       labels:
#         app: kafka-broker
#     spec:
#       hostname: kafka-broker
#       containers:
#         - env:
#             - name: KAFKA_BROKER_ID
#               value: "1"
#             - name: KAFKA_ZOOKEEPER_CONNECT
#               value: zookeeper-service.kafka.svc.cluster.local:2181
#             - name: KAFKA_LISTENERS
#               value: PLAINTEXT://:9092
#             - name: KAFKA_ADVERTISED_LISTENERS
#               value: PLAINTEXT://kafka-srv:9092
#           image: wurstmeister/kafka
#           imagePullPolicy: IfNotPresent
#           name: kafka-broker
#           ports:
#             - containerPort: 9092
#           resources:
#             requests:
#               memory: "1Gi"
#               cpu: "500m"
#             limits:
#               memory: "2Gi"
#               cpu: "1"
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   namespace: kafka
#   labels:
#     app: kafka-broker
#   name: kafka-srv
# spec:
#   selector:
#     app: kafka-broker
#   ports:
#     - name: kafka-broker
#       protocol: TCP
#       port: 9092
#       targetPort: 9092


# ======================================================================

# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   namespace: kafka
#   labels:
#     app: zookeeper
#   name: zookeeper
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: zookeeper
#   template:
#     metadata:
#       labels:
#         app: zookeeper
#     spec:
#       containers:
#         - image: wurstmeister/zookeeper
#           imagePullPolicy: IfNotPresent
#           name: zookeeper
#           ports:
#             - containerPort: 2181
#           resources:
#             requests:
#               memory: "512Mi"
#               cpu: "250m"
#             limits:
#               memory: "1Gi"
#               cpu: "500m"
#           readinessProbe:
#             exec:
#               command:
#                 - sh
#                 - -c
#                 - echo ruok | nc localhost 2181 | grep imok
#             initialDelaySeconds: 10
#             periodSeconds: 5
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   namespace: kafka
#   labels:
#     app: zookeeper
#   name: zookeeper-service
# spec:
#   type: ClusterIP
#   selector:
#     app: zookeeper
#   ports:
#     - name: zookeeper-port
#       port: 2181
#       targetPort: 2181
# ---
# apiVersion: apps/v1
# kind: Deployment
# metadata:
#   namespace: kafka
#   labels:
#     app: kafka-broker
#   name: kafka-broker
# spec:
#   replicas: 1
#   selector:
#     matchLabels:
#       app: kafka-broker
#   template:
#     metadata:
#       labels:
#         app: kafka-broker
#     spec:
#       hostname: kafka-broker
#       containers:
#         - env:
#             - name: KAFKA_BROKER_ID
#               value: "1"
#             - name: KAFKA_ZOOKEEPER_CONNECT
#               value: zookeeper-service.kafka.svc.cluster.local:2181
#             - name: KAFKA_LISTENERS
#               value: PLAINTEXT://0.0.0.0:9092,INSIDE://kafka-broker:9093
#             - name: KAFKA_ADVERTISED_LISTENERS
#               value: PLAINTEXT://kafka-srv.kafka.svc.cluster.local:9092,INSIDE://kafka-broker.kafka.svc.cluster.local:9093
#             - name: KAFKA_LISTENER_SECURITY_PROTOCOL_MAP
#               value: INSIDE:PLAINTEXT,PLAINTEXT:PLAINTEXT
#             - name: KAFKA_LISTENER_SECURITY_PROTOCOL
#               value: PLAINTEXT
#             - name: KAFKA_LISTENER_NAME_INSIDE_SECURITY_PROTOCOL
#               value: PLAINTEXT
#             - name: KAFKA_LISTENER_NAME_PLAINTEXT_SECURITY_PROTOCOL
#               value: PLAINTEXT
#             - name: KAFKA_LISTENERS_PORT
#               value: "9092"
#           image: wurstmeister/kafka
#           imagePullPolicy: IfNotPresent
#           name: kafka-broker
#           ports:
#             - containerPort: 9092
#           resources:
#             requests:
#               memory: "1Gi"
#               cpu: "500m"
#             limits:
#               memory: "2Gi"
#               cpu: "1"
# ---
# apiVersion: v1
# kind: Service
# metadata:
#   namespace: kafka
#   labels:
#     app: kafka-broker
#   name: kafka-srv
# spec:
#   selector:
#     app: kafka-broker
#   ports:
#     - name: kafka-broker
#       protocol: TCP
#       port: 9092
#       targetPort: 9092


apiVersion: apps/v1
kind: Deployment
metadata:
    labels:
        app: zookeeper
    name: zookeeper
spec:
    replicas: 1
    selector:
        matchLabels:
            app: zookeeper
    template:
        metadata:
            labels:
                app: zookeeper
        spec:
            containers:
                - image: wurstmeister/zookeeper
                  imagePullPolicy: IfNotPresent
                  name: zookeeper
                  ports:
                      - containerPort: 2181
---
apiVersion: v1
kind: Service
metadata:
    labels:
        app: zookeeper-service
    name: zookeeper-service
spec:
    type: NodePort
    selector:
        app: zookeeper
    ports:
        - name: zookeeper-port
          port: 2181
          targetPort: 2181
---
apiVersion: apps/v1
kind: Deployment
metadata:
    labels:
        app: kafka-broker
    name: kafka-broker
spec:
    replicas: 1
    selector:
        matchLabels:
            app: kafka-broker
    template:
        metadata:
            labels:
                app: kafka-broker
        spec:
            hostname: kafka-broker
            containers:
                - env:
                      - name: KAFKA_BROKER_ID
                        value: "1"
                      - name: KAFKA_ZOOKEEPER_CONNECT
                        value: zookeeper-service:2181
                      - name: KAFKA_LISTENERS
                        value: PLAINTEXT://:9092
                      - name: KAFKA_ADVERTISED_LISTENERS
                        value: PLAINTEXT://kafka-srv:9092
                  image: wurstmeister/kafka
                  imagePullPolicy: IfNotPresent
                  name: kafka-broker
                  ports:
                      - containerPort: 9092
---
apiVersion: v1
kind: Service
metadata:
    labels:
        app: kafka-broker
    name: kafka-srv
spec:
    selector:
        app: kafka-broker
    ports:
        - name: kafka-broker
          protocol: TCP
          port: 9092
          targetPort: 9092